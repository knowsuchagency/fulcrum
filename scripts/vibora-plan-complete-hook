#!/bin/bash
# Vibora Stop Hook - Automatically transitions tasks to IN_REVIEW when Claude finishes
#
# This hook runs when Claude Code stops. If we're in a Vibora worktree with a task
# that's IN_PROGRESS, it transitions the task to IN_REVIEW.
#
# Installation:
#   Add to ~/.claude/settings.json or .claude/settings.json:
#   {
#     "hooks": {
#       "Stop": [{
#         "hooks": [{
#           "type": "command",
#           "command": "vibora-plan-complete-hook"
#         }]
#       }]
#     }
#   }
#
# The script must be in PATH, or use an absolute path in the command.

set -e

# Read hook input from stdin (JSON with session_id, transcript_path, cwd, etc.)
# We don't need to parse it for our purposes - we just check current directory

# Check if vibora CLI is available
if ! command -v vibora &> /dev/null; then
  exit 0
fi

# Check if we're in a Vibora worktree by trying to get current task
TASK_OUTPUT=$(vibora current-task 2>/dev/null) || exit 0

# Parse the status from the output
# The output format is: "Title: ...\nStatus: IN_PROGRESS\n..."
CURRENT_STATUS=$(echo "$TASK_OUTPUT" | grep -E "^Status:" | awk '{print $2}' || echo "")

# Only transition if task is IN_PROGRESS
if [ "$CURRENT_STATUS" = "IN_PROGRESS" ]; then
  vibora current-task review >/dev/null 2>&1 || true
fi

exit 0
