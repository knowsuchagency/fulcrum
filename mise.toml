[tools]
bun = "latest"

[hooks.postinstall]
run = "bun install"

[tasks.install]
description = "Install dependencies"
run = "bun install"

[tasks.bump]
description = "Bump version (major, minor, or patch)"
usage = 'arg "[type]" help="Version type: major, minor, or patch" default="patch"'
run = """
#!/usr/bin/env bash
set -e
current=$(jq -r '.version' package.json)
IFS='.' read -r major minor patch <<< "$current"

case "${usage_type}" in
  major) major=$((major + 1)); minor=0; patch=0 ;;
  minor) minor=$((minor + 1)); patch=0 ;;
  patch) patch=$((patch + 1)) ;;
  *) echo "Invalid type: ${usage_type}. Use major, minor, or patch" >&2; exit 1 ;;
esac

new_version="$major.$minor.$patch"

# Update package.json
jq --arg v "$new_version" '.version = $v' package.json > package.json.tmp && mv package.json.tmp package.json
echo "Updated package.json: $current → $new_version"

# Update plugin marketplace.json
marketplace=".claude-plugin/marketplace.json"
if [ -f "$marketplace" ]; then
  jq --arg v "$new_version" '.plugins[0].version = $v' "$marketplace" > "${marketplace}.tmp" && mv "${marketplace}.tmp" "$marketplace"
  echo "Updated $marketplace"
fi

# Update plugin.json
plugin="plugins/vibora/.claude-plugin/plugin.json"
if [ -f "$plugin" ]; then
  jq --arg v "$new_version" '.version = $v' "$plugin" > "${plugin}.tmp" && mv "${plugin}.tmp" "$plugin"
  echo "Updated $plugin"
fi

echo "Bumped version: $current → $new_version"

git add package.json "$marketplace" "$plugin"
git commit -m "bump ${usage_type}"
"""

[tasks.dev]
description = "Start frontend and backend dev servers"
depends = ["install"]
usage = '''
arg "[port]" help="Port to run on" default="3222"
arg "[dir]" help="Vibora directory" default="~/.vibora/dev"
flag "--db" help="Database path (overrides dir/vibora.db)"
'''
run = """
export PORT="${usage_port}"
export VITE_BACKEND_PORT="${usage_port}"
export VIBORA_DIR="${VIBORA_DIR:-${usage_dir}}"
if [ -n "${usage_db}" ]; then
  export VIBORA_DATABASE_PATH="${usage_db}"
fi
bunx concurrently -n server,client -c blue,green 'mise run server' 'mise run client'
"""

[tasks.server]
description = "Start backend dev server with auto-reload"
run = """
mkdir -p "${VIBORA_DIR:-$HOME/.vibora}"
bun run drizzle-kit push
bun --watch server/index.ts
"""

[tasks.client]
description = "Start frontend dev server"
run = "vite --host"

[tasks.build]
description = "Build for production"
run = "bunx tsc -b && bunx vite build"

[tasks.start]
description = "Run production server"
depends = ["build"]
run = "NODE_ENV=production bun server/index.ts"

[tasks.lint]
description = "Run ESLint"
run = "bunx eslint ."

[tasks.typecheck]
description = "Check TypeScript types"
run = "bunx tsc --noEmit"

[tasks.check]
description = "Run all checks (lint + typecheck)"
depends = ["lint", "typecheck"]

[tasks.preview]
description = "Preview production build"
run = "vite preview"

[tasks."db:push"]
description = "Sync schema to database"
run = "bun run drizzle-kit push"

[tasks."db:studio"]
description = "Open Drizzle Studio GUI"
run = "bun run drizzle-kit studio"

[tasks."db:generate"]
description = "Generate migrations"
run = "bun run drizzle-kit generate"

[tasks."db:migrate"]
description = "Apply migrations"
run = "bun run drizzle-kit migrate"

# CLI tasks
[tasks."cli"]
description = "Run CLI command"
usage = 'arg "[args]..." help="Arguments to pass to CLI" default=""'
run = "bun cli/src/index.ts ${usage_args}"

[tasks."cli:link"]
description = "Link CLI for global access"
dir = "cli"
run = "bun link"

[tasks."cli:typecheck"]
description = "Typecheck CLI"
run = "bunx tsc --noEmit -p cli/tsconfig.json"

[tasks."cli:build"]
description = "Build CLI package for npm distribution"
depends = ["build"]
run = """
set -e

# Generate cli/package.json from root package.json
echo "Generating cli/package.json..." >&2
jq '{
  name,
  version,
  description,
  license,
  repository: {type: "git", url: "https://github.com/knowsuchagency/vibora"},
  homepage: "https://github.com/knowsuchagency/vibora",
  type: "module",
  bin: {vibora: "bin/vibora.js"},
  files: ["bin/", "server/", "lib/", "dist/", "drizzle/", "README.md", "LICENSE"],
  engines: {bun: ">=1.0.0"}
}' package.json > cli/package.json

# Bundle server
echo "Bundling server..." >&2
bun build server/index.ts --target=bun --outfile=cli/server/index.js

# Bundle CLI with node shebang
echo "Bundling CLI..." >&2
mkdir -p cli/bin
bun build cli/src/index.ts --target=bun --outfile=cli/bin/vibora.js
# Replace bun shebang with node (npm requirement) - bun is still invoked at runtime
# Use perl for cross-platform compatibility (macOS sed -i differs from GNU sed)
perl -i -pe 's|#!/usr/bin/env bun|#!/usr/bin/env node| if $. == 1' cli/bin/vibora.js

# Copy native PTY libraries (all platforms)
echo "Copying native PTY libraries..." >&2
mkdir -p cli/lib
cp node_modules/bun-pty/rust-pty/target/release/librust_pty.so cli/lib/ 2>/dev/null || true
cp node_modules/bun-pty/rust-pty/target/release/librust_pty_arm64.so cli/lib/ 2>/dev/null || true
cp node_modules/bun-pty/rust-pty/target/release/librust_pty.dylib cli/lib/ 2>/dev/null || true
cp node_modules/bun-pty/rust-pty/target/release/librust_pty_arm64.dylib cli/lib/ 2>/dev/null || true
cp node_modules/bun-pty/rust-pty/target/release/rust_pty.dll cli/lib/ 2>/dev/null || true

# Generate SQL migrations
echo "Generating migrations..." >&2
bunx drizzle-kit generate
mkdir -p cli/drizzle
cp -r drizzle/* cli/drizzle/

# Copy frontend build
echo "Copying frontend build..." >&2
mkdir -p cli/dist
cp -r dist/* cli/dist/

# Copy README and LICENSE
echo "Copying README and LICENSE..." >&2
cp README.md cli/
cp LICENSE cli/

echo "CLI package built successfully"
"""

[tasks."cli:publish"]
description = "Publish CLI to npm"
depends = ["cli:build"]
dir = "cli"
usage = 'arg "<otp>" help="npm one-time password for 2FA"'
run = "npm publish --access public --otp=${usage_otp}"

# Production daemon tasks
[tasks.up]
description = "Build and start production server as daemon"
depends = ["install", "build"]
run = """
set -e

VIBORA_DIR="${VIBORA_DIR:-$HOME/.vibora}"
PID_FILE="$VIBORA_DIR/vibora.pid"
SETTINGS_FILE="$VIBORA_DIR/settings.json"

# Determine port: env var > settings.json > default 3333
if [ -z "$PORT" ]; then
  if [ -f "$SETTINGS_FILE" ] && command -v jq >/dev/null 2>&1; then
    PORT=$(jq -r '.port // empty' "$SETTINGS_FILE" 2>/dev/null)
  fi
  PORT="${PORT:-3333}"
fi

# Check if already running
if [ -f "$PID_FILE" ]; then
  PID=$(cat "$PID_FILE")
  if kill -0 "$PID" 2>/dev/null; then
    echo "Vibora already running (PID: $PID)" >&2
    exit 1
  fi
fi

# Sync database
echo "Syncing database..." >&2
bun run drizzle-kit push

# Start server in background
echo "Starting server..." >&2
mkdir -p "$VIBORA_DIR"
nohup env NODE_ENV=production PORT="$PORT" bun server/index.ts \
  > "$VIBORA_DIR/server.log" 2>&1 &
PID=$!

# Write PID file
echo "$PID" > "$PID_FILE"

# Verify it started
sleep 1
if ! kill -0 "$PID" 2>/dev/null; then
  echo "Server failed to start. Check $VIBORA_DIR/server.log" >&2
  rm -f "$PID_FILE"
  exit 1
fi

echo "Vibora started on http://localhost:$PORT (PID: $PID)"
"""

[tasks.down]
description = "Stop the daemon server"
run = """
PID_FILE="${VIBORA_DIR:-$HOME/.vibora}/vibora.pid"
if [ ! -f "$PID_FILE" ]; then
  echo "No PID file found" >&2
  exit 1
fi

PID=$(cat "$PID_FILE")
if kill -0 "$PID" 2>/dev/null; then
  kill "$PID"
  echo "Stopped Vibora (PID: $PID)"
else
  echo "Process not running"
fi
rm -f "$PID_FILE"
"""

[tasks.restart]
description = "Restart vibora-dev systemd service with migrations"
run = """
set -e

echo "Syncing database schema..." >&2
bun run drizzle-kit push

echo "Restarting vibora-dev..." >&2
systemctl --user restart vibora-dev

echo "Done. Checking status..." >&2
systemctl --user status vibora-dev --no-pager
"""

# Desktop app tasks (client-only, connects to local or remote Vibora server)
[tasks."desktop:setup"]
description = "Install Neutralinojs CLI and dependencies"
run = """
set -e

# Check if neu CLI is installed
if ! command -v neu &> /dev/null; then
  echo "Installing Neutralinojs CLI..." >&2
  npm install -g @neutralinojs/neu
fi

# Download Neutralino binaries to desktop/
cd desktop
if [ ! -f "bin/neutralino-linux_x64" ]; then
  echo "Downloading Neutralino binaries..." >&2
  neu update
fi

echo "Neutralinojs setup complete"
"""

[tasks."desktop:build"]
description = "Build desktop client app for current platform"
depends = ["desktop:setup"]
run = """
set -e

cd desktop

echo "Building Neutralino app..." >&2
neu build

echo ""
echo "Desktop app built successfully!"
echo "Binaries are in: desktop/dist/"
echo ""
echo "The app will connect to a Vibora server running locally or remotely."
"""

[tasks."desktop:run"]
description = "Run desktop app in development mode"
depends = ["desktop:setup"]
run = """
cd desktop
neu run
"""

[tasks."desktop:clean"]
description = "Clean desktop build artifacts"
run = """
rm -rf desktop/dist
rm -rf desktop/bin
echo "Desktop build artifacts cleaned"
"""

[tasks."desktop:package-appimage"]
description = "Package desktop app as AppImage (Linux)"
depends = ["desktop:build"]
usage = 'arg "[arch]" help="Architecture: x64 or arm64" default="x64"'
run = """
./desktop/scripts/package-appimage.sh "${usage_arch}"
"""

[tasks."desktop:package-dmg"]
description = "Package desktop app as DMG (macOS)"
depends = ["desktop:build"]
usage = 'arg "[arch]" help="Architecture: x64 or arm64" default=""'
run = """
./desktop/scripts/package-dmg.sh "${usage_arch}"
"""

[tasks."desktop:package"]
description = "Package desktop app for current platform"
depends = ["desktop:build"]
run = """
set -e

case "$(uname -s)" in
  Linux*)
    if [ "$(uname -m)" = "aarch64" ]; then
      ./desktop/scripts/package-appimage.sh arm64
    else
      ./desktop/scripts/package-appimage.sh x64
    fi
    ;;
  Darwin*)
    if [ "$(uname -m)" = "arm64" ]; then
      ./desktop/scripts/package-dmg.sh arm64
    else
      ./desktop/scripts/package-dmg.sh x64
    fi
    ;;
  *)
    echo "Packaging not supported on this platform"
    exit 1
    ;;
esac
"""
